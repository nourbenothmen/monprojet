"use strict";(self.webpackChunkskeleton=self.webpackChunkskeleton||[]).push([[769],{482:(f,g,o)=>{o.d(g,{P:()=>d});var d=function(i){return i.REGLE="REGLE",i.NON_REGLE="NON_REGLE",i}(d||{})},676:(f,g,o)=>{o.d(g,{Q:()=>t});var d=o(9437),i=o(7673),h=o(8564),m=o(2306);let t=(()=>{class a{constructor(r){this.http=r,this.baseURL="http://localhost:8083/api/factures"}calculateCAByMonthAndYear(r,_){return this.http.get(`${this.baseURL}/calculateCAByMonthAndYear?month=${r}&year=${_}`)}calculateCAByYear(r){return this.http.get(`${this.baseURL}/calculateCAByYear?year=${r}`)}getFacturesByStatus(r){return this.http.get(`${this.baseURL}/status/${r}`)}calculateCAByWeekAndYear(r,_){return this.http.get(`${this.baseURL}/calculateCAByWeekAndYear?week=${r}&year=${_}`)}getAllFactures(){return this.http.get(`${this.baseURL}`)}getFacturesByClient(r){return this.http.get(`${this.baseURL}/client/${r}`)}deleteFacture(r){return this.http.delete(`${this.baseURL}/${r}`)}createFacture(r){return this.http.post(this.baseURL,r)}updateFacture(r,_){return this.http.put(`${this.baseURL}/${r}`,_)}getCAByMonthForYear(r){return this.http.get(`${this.baseURL}/caByMonthForYear?year=${r}`)}getTopLoyalClientsByYear(r){return this.http.get(`${this.baseURL}/top-loyal-clients?year=${r}`)}getTotalRemainingAmount(){return this.http.get(`${this.baseURL}/total-remaining-amount`).pipe((0,d.W)(r=>(console.error("Erreur lors de la r\xe9cup\xe9ration du reste global:",r),(0,i.of)(0))))}getDebtsByClient(){return this.http.get(`${this.baseURL}/debts-by-client`).pipe((0,d.W)(r=>(console.error("Erreur lors de la r\xe9cup\xe9ration des dettes par client:",r),(0,i.of)([]))))}getTotalClients(){return this.http.get(`${this.baseURL}/total`).pipe((0,d.W)(r=>(console.error("Erreur lors de la r\xe9cup\xe9ration du total des clients:",r),(0,i.of)(0))))}static{this.\u0275fac=function(_){return new(_||a)(h.KVO(m.Qq))}}static{this.\u0275prov=h.jDH({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})()},1838:(f,g,o)=>{o.d(g,{c:()=>m});var d=o(9437),i=o(8564),h=o(2306);let m=(()=>{class t{constructor(c){this.http=c,this.apiUrl="http://localhost:8085/api/devises"}getAllDevises(){return this.http.get(this.apiUrl)}createDevise(c){return this.http.post(this.apiUrl,c)}updateDevise(c,r){return this.http.put(`${this.apiUrl}/${c}`,r)}deleteDevise(c){return this.http.delete(`${this.apiUrl}/${c}`).pipe((0,d.W)(r=>{throw console.error("D\xe9tails erreur suppression:",r),r}))}static{this.\u0275fac=function(r){return new(r||t)(i.KVO(h.Qq))}}static{this.\u0275prov=i.jDH({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})()},2529:(f,g,o)=>{o.d(g,{r:()=>h});var d=o(8564),i=o(2306);let h=(()=>{class m{constructor(a){this.http=a,this.apiUrl="http://localhost:8087/api/reglements"}getAllReglements(){return this.http.get(this.apiUrl)}getReglementById(a){return this.http.get(`${this.apiUrl}/${a}`)}createReglement(a){return this.http.post(this.apiUrl,a)}updateReglement(a,c){return this.http.put(`${this.apiUrl}/${a}`,c)}getReglementsByFactureId(a){return this.http.get(`${this.apiUrl}/facture/${a}`)}deleteReglement(a){return this.http.delete(`${this.apiUrl}/${a}`)}static{this.\u0275fac=function(c){return new(c||m)(d.KVO(i.Qq))}}static{this.\u0275prov=d.jDH({token:m,factory:m.\u0275fac,providedIn:"root"})}}return m})()},3964:(f,g,o)=>{o.d(g,{r:()=>A});var d=o(6396),i=o(9417),h=o(5727),m=o(482),t=o(7241),a=o(8564),c=o(3525),r=o(2529),_=o(676);function R(l,p){1&l&&(t.j41(0,"div",3)(1,"div",4)(2,"span",5),t.EFF(3,"Chargement..."),t.k0s()(),t.j41(4,"p"),t.EFF(5,"Chargement des donn\xe9es..."),t.k0s()())}function E(l,p){if(1&l&&(t.j41(0,"option",21),t.EFF(1),t.k0s()),2&l){const e=p.$implicit,s=t.XpG(2);t.Y8G("ngValue",e.id),t.R7$(),t.LHq(" ",e.id," - ",(null==e.client?null:e.client.name)||"Client inconnu"," (Restant: ",e.resteAPayer," ",s.getDeviseSymbol(e.deviseId),") ")}}function v(l,p){if(1&l&&(t.j41(0,"small"),t.EFF(1),t.k0s()),2&l){const e=t.XpG(2);t.R7$(),t.SpI("\xc9quivalent en DT: ",e.montantConvertiDT.toFixed(2)," DT")}}function M(l,p){if(1&l&&(t.j41(0,"option",21),t.EFF(1),t.k0s()),2&l){const e=p.$implicit;t.Y8G("ngValue",e),t.R7$(),t.SpI(" ",e," ")}}function C(l,p){if(1&l&&(t.j41(0,"option",21),t.EFF(1),t.k0s()),2&l){const e=p.$implicit;t.Y8G("ngValue",e.id),t.R7$(),t.Lme(" ",e.nom," (",e.symbole,") ")}}function D(l,p){if(1&l){const e=t.RV6();t.j41(0,"form",6),t.bIt("ngSubmit",function(){a.eBV(e);const n=t.XpG();return a.Njj(n.saveReglement())}),t.j41(1,"div",7)(2,"label",8),t.EFF(3,"Facture"),t.k0s(),t.j41(4,"select",9),t.mxI("ngModelChange",function(n){a.eBV(e);const u=t.XpG();return t.DH7(u.reglement.factureId,n)||(u.reglement.factureId=n),a.Njj(n)}),t.bIt("change",function(){a.eBV(e);const n=t.XpG();return a.Njj(n.updateFactureDetails())}),t.j41(5,"option",10),t.EFF(6,"S\xe9lectionner une facture"),t.k0s(),t.DNE(7,E,2,5,"option",11),t.k0s()(),t.j41(8,"div",7)(9,"label",12),t.EFF(10,"Montant"),t.k0s(),t.j41(11,"div",13)(12,"input",14),t.mxI("ngModelChange",function(n){a.eBV(e);const u=t.XpG();return t.DH7(u.reglement.montant,n)||(u.reglement.montant=n),a.Njj(n)}),t.bIt("change",function(){a.eBV(e);const n=t.XpG();return a.Njj(n.calculateMontant())}),t.k0s(),t.j41(13,"span",15),t.EFF(14),t.k0s()(),t.DNE(15,v,2,1,"small",16),t.k0s(),t.j41(16,"div",7)(17,"label",17),t.EFF(18,"Mode de paiement"),t.k0s(),t.j41(19,"select",18),t.mxI("ngModelChange",function(n){a.eBV(e);const u=t.XpG();return t.DH7(u.reglement.modePaiement,n)||(u.reglement.modePaiement=n),a.Njj(n)}),t.DNE(20,M,2,2,"option",11),t.k0s()(),t.j41(21,"div",7)(22,"label",19),t.EFF(23,"Devise"),t.k0s(),t.j41(24,"select",20),t.mxI("ngModelChange",function(n){a.eBV(e);const u=t.XpG();return t.DH7(u.reglement.deviseId,n)||(u.reglement.deviseId=n),a.Njj(n)}),t.bIt("change",function(){a.eBV(e);const n=t.XpG();return a.Njj(n.calculateMontant())}),t.j41(25,"option",21),t.EFF(26,"S\xe9lectionner une devise"),t.k0s(),t.DNE(27,C,2,3,"option",11),t.k0s()(),t.j41(28,"div",22)(29,"button",23),t.bIt("click",function(){a.eBV(e);const n=t.XpG();return a.Njj(n.activeModal.dismiss())}),t.EFF(30,"Annuler"),t.k0s(),t.j41(31,"button",24),t.EFF(32," Sauvegarder "),t.k0s()()()}if(2&l){const e=t.XpG();t.R7$(4),t.R50("ngModel",e.reglement.factureId),t.R7$(),t.Y8G("ngValue",0),t.R7$(2),t.Y8G("ngForOf",e.factures),t.R7$(5),t.R50("ngModel",e.reglement.montant),t.R7$(2),t.JRh(e.getDeviseSymbol(e.reglement.deviseId)),t.R7$(),t.Y8G("ngIf",e.montantConvertiDT>0),t.R7$(4),t.R50("ngModel",e.reglement.modePaiement),t.R7$(),t.Y8G("ngForOf",e.modePaiementOptions),t.R7$(4),t.R50("ngModel",e.reglement.deviseId),t.R7$(),t.Y8G("ngValue",0),t.R7$(2),t.Y8G("ngForOf",e.devises),t.R7$(4),t.Y8G("disabled",!e.isFormValid())}}let A=(()=>{class l{constructor(e,s,n){this.activeModal=e,this.reglementService=s,this.factureService=n,this.isEdit=!1,this.reglement={montant:0,dateReglement:(new Date).toISOString(),factureId:0,modePaiement:h.j.CASH,deviseId:0},this.factures=[],this.devises=[],this.modePaiementOptions=Object.values(h.j),this.selectedFactureTotal=0,this.originalDeviseId=0,this.montantConvertiDT=0,this.originalMontantRestant=0}get isDataLoaded(){return this.factures.length>0&&this.devises.length>0}getDeviseSymbol(e){return this.devises.find(n=>n.id===e)?.symbole||"TND"}updateFactureDetails(){const e=this.factures.find(s=>s.id===this.reglement.factureId);e&&(this.selectedFactureTotal=e.total||0,this.originalDeviseId=e.deviseId||0,this.reglement.deviseId=e.deviseId||0,this.originalMontantRestant=null!=e.resteAPayer?e.resteAPayer:e.total||0,this.originalMontantRestant<=0&&console.warn("Facture s\xe9lectionn\xe9e a un montant restant <= 0:",e),this.calculateMontant(),this.updateMontantRestant())}calculateMontant(){if(this.reglement.factureId>0&&this.selectedFactureTotal>0&&this.reglement.deviseId>0){const e=this.devises.find(n=>n.id===this.originalDeviseId),s=this.devises.find(n=>n.id===this.reglement.deviseId);e&&s&&e.tauxChange&&s.tauxChange?(this.montantConvertiDT=Math.round(this.reglement.montant*(s.tauxChange/(e.tauxChange||1))*100)/100,Math.abs(this.montantConvertiDT-this.originalMontantRestant)<=.01&&this.montantConvertiDT>=this.originalMontantRestant&&(this.montantConvertiDT=this.originalMontantRestant)):(this.montantConvertiDT=this.reglement.montant,console.warn("No valid tauxChange, using raw montant:",this.reglement.montant)),console.log("calculateMontant Debug:",{reglementMontant:this.reglement.montant,originalDeviseTaux:e?.tauxChange||"N/A",targetDeviseTaux:s?.tauxChange||"N/A",calculatedMontant:this.montantConvertiDT}),this.updateMontantRestant()}}updateMontantRestant(){const e=this.factures.find(s=>s.id===this.reglement.factureId);if(e&&this.montantConvertiDT>0){const s=e.resteAPayer??e.total??0,n=s-this.montantConvertiDT;e.resteAPayer=this.montantConvertiDT>=this.originalMontantRestant?0:Math.max(0,Math.round(100*n)/100),console.log("updateMontantRestant Debug:",{currentMontantRestant:s,montantConvertiDT:this.montantConvertiDT,originalMontantRestant:this.originalMontantRestant,nouveauMontantRestant:n,updatedResteAPayer:e.resteAPayer}),this.updateStatutFacture(e)}}updateStatutFacture(e){e.status=(e.resteAPayer??e.total??0)<=.01?m.P.REGLE:m.P.NON_REGLE}get filteredFactures(){return this.factures.filter(e=>(e.resteAPayer??e.total??0)>0)}isFormValid(){const e=this.factures.find(u=>u.id===this.reglement.factureId),s=this.montantConvertiDT||this.reglement.montant;console.log("isFormValid Debug:",{facture:e,originalMontantRestant:this.originalMontantRestant,montantConvertiDT:s,reglement:this.reglement});const n=this.reglement.montant>0&&this.reglement.factureId>0&&null!=this.reglement.modePaiement&&this.reglement.deviseId>0&&(!(this.originalMontantRestant>0)||s<=this.originalMontantRestant)&&s>0;return console.log("isValid:",n),n}saveReglement(){if(!this.isFormValid())return console.warn("Formulaire invalide"),void alert("Le montant pay\xe9 ne peut pas d\xe9passer le montant restant initial de la facture.");const e=this.factures.find(n=>n.id===this.reglement.factureId);if(e){if(this.updateMontantRestant(),this.updateStatutFacture(e),void 0===e.id)return void console.error("Erreur: facture.id est undefined");this.factureService.updateFacture(e.id,e).subscribe({next:()=>console.log("Facture mise \xe0 jour:",e),error:n=>console.error("Erreur mise \xe0 jour facture:",n)})}(this.isEdit&&this.reglement.id?this.reglementService.updateReglement(this.reglement.id,this.reglement):this.reglementService.createReglement(this.reglement)).subscribe({next:n=>{this.activeModal.close(n),this.loadDataAfterSave()},error:n=>{console.error("Erreur:",n),alert(`Erreur: ${n.error?.message||"Une erreur est survenue"}`)}})}loadDataAfterSave(){}static{this.\u0275fac=function(s){return new(s||l)(t.rXU(c.Lw),t.rXU(r.r),t.rXU(_.Q))}}static{this.\u0275cmp=t.VBU({type:l,selectors:[["app-add-edit-reglement-modal"]],inputs:{isEdit:"isEdit",reglement:"reglement",factures:"factures",devises:"devises"},decls:3,vars:2,consts:[[1,"modal-body"],["class","text-center",4,"ngIf"],[3,"ngSubmit",4,"ngIf"],[1,"text-center"],["role","status",1,"spinner-border"],[1,"visually-hidden"],[3,"ngSubmit"],[1,"mb-3"],["for","factureId",1,"form-label"],["id","factureId","name","factureId","required","",1,"form-select",3,"ngModelChange","change","ngModel"],["disabled","",3,"ngValue"],[3,"ngValue",4,"ngFor","ngForOf"],["for","montant",1,"form-label"],[1,"input-group"],["type","number","id","montant","name","montant","min","0.01","step","0.01","required","",1,"form-control",3,"ngModelChange","change","ngModel"],[1,"input-group-text"],[4,"ngIf"],["for","modePaiement",1,"form-label"],["id","modePaiement","name","modePaiement","required","",1,"form-select",3,"ngModelChange","ngModel"],["for","deviseId",1,"form-label"],["id","deviseId","name","deviseId","required","",1,"form-select",3,"ngModelChange","change","ngModel"],[3,"ngValue"],[1,"modal-footer"],["type","button",1,"btn","btn-secondary",3,"click"],["type","submit",1,"btn","btn-primary",3,"disabled"]],template:function(s,n){1&s&&(t.j41(0,"div",0),t.DNE(1,R,6,0,"div",1)(2,D,33,12,"form",2),t.k0s()),2&s&&(t.R7$(),t.Y8G("ngIf",!n.isDataLoaded),t.R7$(),t.Y8G("ngIf",n.isDataLoaded))},dependencies:[d.MD,d.Sq,d.bT,i.YN,i.qT,i.xH,i.y7,i.me,i.Q0,i.wz,i.BC,i.cb,i.YS,i.VZ,i.vS,i.cV],encapsulation:2})}}return l})()},5727:(f,g,o)=>{o.d(g,{j:()=>d});var d=function(i){return i.CASH="CASH",i.CHECK="CHECK",i.BANK_TRANSFER="BANK_TRANSFER",i.CREDIT_CARD="CREDIT_CARD",i}(d||{})}}]);